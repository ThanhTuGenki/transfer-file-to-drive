// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum DriveAccountStatus {
    ACTIVE
    INACTIVE
    QUOTA_EXCEEDED
    AUTH_ERROR
}

enum CourseStatus {
    AVAILABLE
    PENDING
    UNAVAILABLE
}

enum UserRole {
    USER
    ADMIN
}

enum PaymentStatus {
    PENDING
    COMPLETED
    FAILED
    CANCELLED
    REFUNDED
}

enum PaymentMethod {
    MOMO
}

enum OrderStatus {
    PENDING
    COMPLETED
    CANCELLED
}

enum ShareStatus {
    PENDING
    SHARED
    FAILED
}

model DriveAccount {
    id             String             @id @default(cuid())
    name           String             @db.VarChar(255)
    email          String             @unique
    accessToken    String?            @map("access_token") @db.Text
    refreshToken   String?            @map("refresh_token") @db.Text
    tokenExpiresAt DateTime?          @map("token_expires_at") @db.Timestamptz
    status         DriveAccountStatus @default(INACTIVE)
    storageUsed    BigInt             @default(0) @map("storage_used")
    storageTotal   BigInt             @default(0) @map("storage_total")

    createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
    updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz
    courses   Course[]

    @@index([status])
    @@index([storageTotal])
    @@map("drive_accounts")
}

model Category {
    id          String   @id @default(cuid())
    name        String   @unique @db.VarChar(255)
    slug        String   @unique @db.VarChar(255)
    description String?
    createdAt   DateTime @default(now()) @map("created_at")
    updatedAt   DateTime @updatedAt @map("updated_at")

    courses CourseCategory[]

    @@map("categories")
}

model CourseCategory {
    course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
    courseId String @map("course_id")

    category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
    categoryId String   @map("category_id")

    @@id([courseId, categoryId])
    @@index([categoryId])
    @@map("course_categories")
}

model Instructor {
    id        String   @id @default(cuid())
    name      String   @db.VarChar(255)
    slug      String   @unique @db.VarChar(255)
    avatarUrl String?  @map("avatar_url")
    bio       String?
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    courses CourseInstructor[]

    @@map("instructors")
}

model CourseInstructor {
    course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
    courseId String @map("course_id")

    instructor   Instructor @relation(fields: [instructorId], references: [id], onDelete: Cascade)
    instructorId String     @map("instructor_id")

    @@id([courseId, instructorId])
    @@index([instructorId])
    @@map("course_instructors")
}

model Course {
    id            String  @id @default(cuid())
    sourceUrl     String  @unique @map("source_url") @db.VarChar(2048)
    title         String  @db.VarChar(255)
    description   String?
    thumbnailUrl  String? @map("thumbnail_url") @db.VarChar(2048)
    duration      String? @db.VarChar(100)
    lecturesCount Int?    @map("lectures_count")

    price         Decimal      @default(0) @db.Decimal(12, 0)
    originalPrice Decimal?     @map("original_price") @db.Decimal(12, 0)
    status        CourseStatus @default(PENDING)

    driveFolderId String? @map("drive_folder_id") @db.VarChar(255)

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    driveAccount   DriveAccount? @relation(fields: [driveAccountId], references: [id], onDelete: SetNull)
    driveAccountId String?       @map("drive_account_id")

    categories  CourseCategory[]
    instructors CourseInstructor[]
    orders      Order[]
    orderItems  OrderItem[]

    @@index([status])
    @@index([driveAccountId])
    @@index([driveFolderId])
    @@index([createdAt])
    @@index([status, price])
    @@map("courses")
}

model Order {
    id          String      @id @default(cuid())
    orderCode   String      @unique @default(cuid()) @map("order_code")
    totalAmount Decimal     @map("total_amount") @db.Decimal(12, 0)
    status      OrderStatus @default(PENDING)
    createdAt   DateTime    @default(now()) @map("created_at")
    updatedAt   DateTime    @updatedAt @map("updated_at")

    // Relations
    user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)
    userId String @map("user_id")

    payments Payment[]
    items    OrderItem[]
    course   Course?     @relation(fields: [courseId], references: [id])
    courseId String?     @map("course_id")

    @@index([userId])
    @@index([status])
    @@index([courseId])
    @@map("orders")
}

model OrderItem {
    id          String  @id @default(cuid())
    price       Decimal @db.Decimal(12, 0)
    courseTitle String  @map("course_title") @db.VarChar(255)

    shareStatus     ShareStatus @default(PENDING) @map("share_status")
    sharedDriveLink String?     @map("shared_drive_link") @db.VarChar(2048)

    // Relations
    order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
    orderId String @map("order_id")

    course   Course @relation(fields: [courseId], references: [id], onDelete: Restrict)
    courseId String @map("course_id")

    @@unique([orderId, courseId])
    @@index([courseId])
    @@index([shareStatus])
    @@map("order_items")
}

model User {
    id    String  @id @default(cuid())
    email String  @unique @db.VarChar(255)
    name  String? @db.VarChar(255)

    image         String?   @db.VarChar(2048)
    emailVerified DateTime? @map("email_verified")

    role     UserRole @default(USER)
    password String?  @db.Text

    // Refresh Token fields
    refreshToken String? @map("refresh_token") @db.Text
    tokenVersion Int     @default(0) @map("token_version")

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    accounts Account[]
    orders   Order[]

    @@index([role])
    @@map("users")
}

model Payment {
    id            String        @id @default(cuid())
    amount        Decimal       @db.Decimal(12, 0)
    status        PaymentStatus @default(PENDING)
    method        PaymentMethod
    transactionId String?       @unique @map("transaction_id") @db.VarChar(255)
    requestId     String?       @unique @map("request_id") @db.VarChar(255)
    paymentData   Json?         @map("payment_data")
    createdAt     DateTime      @default(now()) @map("created_at")
    updatedAt     DateTime      @updatedAt @map("updated_at")

    // Relations
    order   Order  @relation(fields: [orderId], references: [id])
    orderId String @map("order_id")

    @@index([orderId])
    @@index([status])
    @@map("payments")
}

model Account {
    id                String @id @default(cuid())
    userId            String @map("user_id")
    type              String
    provider          String
    providerAccountId String @map("provider_account_id")

    // Các field OAuth của NextAuth
    refresh_token String? @db.Text
    access_token  String? @db.Text
    expires_at    Int?
    token_type    String?
    scope         String?
    id_token      String? @db.Text
    session_state String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
    @@index([userId])
    @@map("accounts")
}
